function O(e){window.enmity.plugins.registerPlugin(e)}const v=window.enmity.modules.common.Constants;window.enmity.modules.common.Clipboard,window.enmity.modules.common.Assets,window.enmity.modules.common.Messages,window.enmity.modules.common.Clyde,window.enmity.modules.common.Avatars;const x=window.enmity.modules.common.Native,r=window.enmity.modules.common.React;window.enmity.modules.common.Dispatcher,window.enmity.modules.common.Storage;const $=window.enmity.modules.common.Toasts;window.enmity.modules.common.Dialog;const B=window.enmity.modules.common.Token;window.enmity.modules.common.REST,window.enmity.modules.common.Settings,window.enmity.modules.common.Users;const H=window.enmity.modules.common.Navigation;window.enmity.modules.common.NavigationNative,window.enmity.modules.common.NavigationStack,window.enmity.modules.common.Theme;const C=window.enmity.modules.common.Linking,V=window.enmity.modules.common.StyleSheet;window.enmity.modules.common.ColorMap,window.enmity.modules.common.Components;const j=window.enmity.modules.common.Locale;window.enmity.modules.common.Profiles,window.enmity.modules.common.Lodash,window.enmity.modules.common.Logger,window.enmity.modules.common.Flux,window.enmity.modules.common.SVG,window.enmity.modules.common.Scenes,window.enmity.modules.common.Moment;const{components:t}=window.enmity;t.Alert,t.Button,t.FlatList;const G=t.Image;t.ImageBackground,t.KeyboardAvoidingView,t.Modal,t.Pressable,t.RefreshControl;const z=t.ScrollView;t.SectionList,t.StatusBar,t.StyleSheet,t.Switch;const T=t.Text;t.TextInput,t.TouchableHighlight,t.TouchableOpacity,t.TouchableWithoutFeedback,t.Touchable;const E=t.View;t.VirtualizedList,t.Form,t.FormArrow,t.FormCTA,t.FormCTAButton,t.FormCardSection,t.FormCheckbox,t.FormDivider,t.FormHint,t.FormIcon,t.FormInput,t.FormLabel,t.FormRadio;const c=t.FormRow,U=t.FormSection;t.FormSelect,t.FormSubLabel,t.FormSwitch,t.FormTernaryCheckBox,t.FormText,t.FormTextColors,t.FormTextSizes;function J(e){return window.enmity.patcher.create(e)}var p="LocalPin",N="1.0.2",K="Pin messages locally",Y=[{name:"mafu",id:"519760564755365888"}],q="#ccffe5",Q={name:p,version:N,description:K,authors:Y,color:q};function S(e){return window.enmity.assets.getIDByName(e)}const h={byProps:(...e)=>window.enmity.modules.filters.byProps(...e),byName:(e,n)=>window.enmity.modules.filters.byName(e,n),byTypeName:(e,n)=>window.enmity.modules.filters.byTypeName(e,n),byDisplayName:(e,n)=>window.enmity.modules.filters.byDisplayName(e,n)};function W(e,n){return window.enmity.modules.getModule(e,n)}function F(...e){return window.enmity.modules.bulk(...e)}function X(...e){return window.enmity.modules.getByProps(...e)}window.enmity.modules.common;const Z=S("img_account_sync_github_white"),ee=S("Discord"),ne=S("img_account_sync_twitter_white"),te=X("acceptInviteAndTransitionToInviteChannel");var oe=({settings:e})=>{const n=V.createThemedStyleSheet({container:{flexDirection:"row",justifyContent:"center",alignItems:"center"},image:{width:70,height:70,marginTop:20,marginLeft:20},title:{flexDirection:"column"},name:{fontSize:30,paddingTop:20,paddingLeft:20,paddingRight:30,color:v.ThemeColorMap.HEADER_PRIMARY},author:{fontSize:15,paddingLeft:50,color:v.ThemeColorMap.HEADER_SECONDARY},info:{height:45,paddingTop:3,paddingBottom:3,justifyContent:"center",alignItems:"center"},footer:{color:v.ThemeColorMap.HEADER_SECONDARY,textAlign:"center",paddingTop:10,paddingBottom:20}});return r.createElement(z,null,r.createElement(E,{style:n.container},r.createElement(G,{source:{uri:"https://avatars.githubusercontent.com/u/43488869"},style:n.image}),r.createElement(E,{style:n.title},r.createElement(T,{style:n.name},"LocalPin"),r.createElement(T,{style:n.author},"by mafu"))),r.createElement(U,{title:"INFORMATION"},r.createElement(c,{label:"Follow me on Twitter",style:n.info,trailing:c.Arrow,leading:r.createElement(c.Icon,{source:ne}),onPress:()=>{C.openURL("https://twitter.com/m4fn3")}}),r.createElement(c,{label:"Visit my server for help",style:n.info,trailing:c.Arrow,leading:r.createElement(c.Icon,{source:ee}),onPress:()=>{te.acceptInviteAndTransitionToInviteChannel({inviteKey:"TrCqPTCrdq",context:{location:"Invite Button Embed"},callback:()=>{H.pop()}})}}),r.createElement(c,{label:"Check Source on GitHub",style:n.info,trailing:c.Arrow,leading:r.createElement(c.Icon,{source:Z}),onPress:()=>{C.openURL("https://github.com/m4fn3/LocalPin")},onLongPress:()=>e.set("_owner",!e.get("_owner"))})),r.createElement(T,{style:n.footer},`v${N}`))};function A(e,n,o){return window.enmity.utilities.findInReactTree(e,n,o)}function L(e,n,o){window.enmity.settings.set(e,n,o)}function P(e,n,o){return window.enmity.settings.get(e,n,o)}const ie=W(e=>{var n,o,l;return(l=(o=(n=e._dispatcher)==null?void 0:n._actionHandlers)==null?void 0:o._dependencyGraph)==null?void 0:l.nodes}),I=ie._dispatcher._actionHandlers._dependencyGraph.nodes;function se(e){let n=Object.keys(I).filter(o=>I[o].name===e);if(n.length)return I[n[0]].actionHandler}const[re,M]=F(h.byProps("getMessage","getMessages"),h.byProps("_currentDispatchActionType","_subscriptions","_actionHandlers","_waitQueue")),[ae]=[se("ChannelPinsStore")];function me(e,n){e.after(ae,"LOAD_PINNED_MESSAGES_SUCCESS",(o,[l],i)=>{n.includes(l.channelId)||n.push(l.channelId)})}function ce(e,n){let o=JSON.parse(P(p,`${e}`,"[]").toString());o.includes(n)||(o.unshift(n),L(p,`${e}`,JSON.stringify(o)))}function le(e,n){let o=JSON.parse(P(p,`${e}`,"[]").toString());o.includes(n)&&(o.splice(o.indexOf(n),1),L(p,`${e}`,JSON.stringify(o)))}function R(e){return JSON.parse(P(p,`${e}`,"[]").toString())}async function de(e,n,o){let l=n.map(s=>s.id),i=Object.keys(o).includes(e)?o[e]:[],y=n.filter(s=>!i.includes(s.id)),d=R(e).filter(s=>!l.includes(s)),a=[];for(const s of d){let m=await ue(e,s);if(!m)continue;let u=re.getMessages(e).receiveMessage(m).get(m.id);a.push(u)}y.unshift(...a.filter(s=>s)),M==null||M.dispatch({type:"LOAD_PINNED_MESSAGES_SUCCESS",messages:y,channelId:e})}async function ue(e,n){let o=await(await fetch(`https://discord.com/api/v9/channels/${e}/messages?around=${n}&limit=1`,{method:"GET",credentials:"include",headers:{authorization:B.getToken()}})).json();if(Array.isArray(o))return o[0]}const g=J("LocalPin"),[D,k,ye]=F(h.byProps("EmojiRow"),h.byName("ActionSheet",!1),h.byProps("openLazy","hideActionSheet"),h.byProps("getMessage","getMessages")),{Version:we}=x.InfoDictionaryManager,ge=S("ic-location"),pe={...Q,onStart(){let e={},n=[],o=0;me(g,n),g.after(E,"render",(i,y,d)=>{const a=A(d,s=>{var m;return((m=s.type)==null?void 0:m.name)==="ChannelPinsConnected"});a&&g.after(a,"type",(s,[m],u)=>{let f=new Date().getTime();f-o>1e3&&Array.isArray(u.props.messages)&&n.includes(m.channelId)&&(o=f,de(m.channelId,u.props.messages,e).then())})});function l(i,y){var d;if((d=i.message)!=null&&d.pinned)return;const a=A(y,b=>Array.isArray(b)&&b.find(w=>{var _;return typeof(w==null?void 0:w.key)=="string"&&typeof((_=w==null?void 0:w.props)==null?void 0:_.message)=="string"}));if(!a)return;let s=R(i.channel.id).includes(i.message.id);const m=r.createElement(c,{label:`${s?"Unpin":"Pin"} Message Locally`,leading:r.createElement(c.Icon,{source:ge}),onPress:()=>{s?(le(i.channel.id,i.message.id),Object.keys(e).includes(i.channel.id)?e[i.channel.id].push(i.message.id):e[i.channel.id]=[i.message.id]):(ce(i.channel.id,i.message.id),Object.keys(e).includes(i.channel.id)&&e[i.channel.id].includes(i.message.id)&&e[i.channel.id].splice(e[i.channel.id].indexOf(i.message.id),1)),$.open({content:`Successfully ${s?"unpinned":"pinned"} message locally`,source:S("ic_check_24px")}),ye.hideActionSheet()}});let u=a.filter(b=>{var w;return((w=b.props)==null?void 0:w.message)===j.Messages.MESSAGE_ACTION_REPLY}),f=u?u.length?Number(u[0].key)+1:void 0:2;f&&a.splice(f,0,m)}parseInt(we.substring(0,3))>164?typeof k.default=="function"&&g.after(k,"default",(i,y,d)=>{const a=A(d,s=>s.sheetKey);(a==null?void 0:a.sheetKey)==="MessageLongPressActionSheet"&&g.after(a==null?void 0:a.content,"type",(s,[m],u)=>{l(m,u)})}):typeof D.default=="function"&&g.after(D,"default",(i,[y],d)=>{l(y,d)})},onStop(){g.unpatchAll()},getSettingsPanel({settings:e}){return r.createElement(oe,{settings:e})}};O(pe);
