function R(e){window.enmity.plugins.registerPlugin(e)}const T=window.enmity.modules.common.Constants;window.enmity.modules.common.Clipboard,window.enmity.modules.common.Assets,window.enmity.modules.common.Messages,window.enmity.modules.common.Clyde,window.enmity.modules.common.Avatars;const k=window.enmity.modules.common.Native,m=window.enmity.modules.common.React;window.enmity.modules.common.Dispatcher,window.enmity.modules.common.Storage;const $=window.enmity.modules.common.Toasts;window.enmity.modules.common.Dialog;const x=window.enmity.modules.common.Token;window.enmity.modules.common.REST,window.enmity.modules.common.Settings,window.enmity.modules.common.Users;const B=window.enmity.modules.common.Navigation;window.enmity.modules.common.NavigationNative,window.enmity.modules.common.NavigationStack,window.enmity.modules.common.Theme;const F=window.enmity.modules.common.Linking,H=window.enmity.modules.common.StyleSheet;window.enmity.modules.common.ColorMap,window.enmity.modules.common.Components;const V=window.enmity.modules.common.Locale;window.enmity.modules.common.Profiles,window.enmity.modules.common.Lodash,window.enmity.modules.common.Logger,window.enmity.modules.common.Flux,window.enmity.modules.common.SVG,window.enmity.modules.common.Scenes,window.enmity.modules.common.Moment;const{components:t}=window.enmity;t.Alert,t.Button,t.FlatList;const j=t.Image;t.ImageBackground,t.KeyboardAvoidingView,t.Modal,t.Pressable,t.RefreshControl;const G=t.ScrollView;t.SectionList,t.StatusBar,t.StyleSheet,t.Switch;const E=t.Text;t.TextInput,t.TouchableHighlight,t.TouchableOpacity,t.TouchableWithoutFeedback,t.Touchable;const A=t.View;t.VirtualizedList,t.Form,t.FormArrow,t.FormCTA,t.FormCTAButton,t.FormCardSection,t.FormCheckbox,t.FormDivider,t.FormHint,t.FormIcon,t.FormInput,t.FormLabel,t.FormRadio;const l=t.FormRow,z=t.FormSection;t.FormSelect,t.FormSubLabel,t.FormSwitch,t.FormTernaryCheckBox,t.FormText,t.FormTextColors,t.FormTextSizes;function U(e){return window.enmity.patcher.create(e)}var h="LocalPin",L="1.0.2",J="Pin messages locally",K=[{name:"mafu",id:"519760564755365888"}],Y="#ccffe5",q={name:h,version:L,description:J,authors:K,color:Y};function f(e){return window.enmity.assets.getIDByName(e)}const S={byProps:(...e)=>window.enmity.modules.filters.byProps(...e),byName:(e,n)=>window.enmity.modules.filters.byName(e,n),byTypeName:(e,n)=>window.enmity.modules.filters.byTypeName(e,n),byDisplayName:(e,n)=>window.enmity.modules.filters.byDisplayName(e,n)};function Q(e,n){return window.enmity.modules.getModule(e,n)}function I(...e){return window.enmity.modules.bulk(...e)}function W(...e){return window.enmity.modules.getByProps(...e)}window.enmity.modules.common;const X=f("img_account_sync_github_white"),Z=f("Discord"),ee=f("img_account_sync_twitter_white"),ne=W("acceptInviteAndTransitionToInviteChannel");var te=({settings:e})=>{const n=H.createThemedStyleSheet({container:{flexDirection:"row",justifyContent:"center",alignItems:"center"},image:{width:70,height:70,marginTop:20,marginLeft:20},title:{flexDirection:"column"},name:{fontSize:30,paddingTop:20,paddingLeft:20,paddingRight:30,color:T.ThemeColorMap.HEADER_PRIMARY},author:{fontSize:15,paddingLeft:50,color:T.ThemeColorMap.HEADER_SECONDARY},info:{height:45,paddingTop:3,paddingBottom:3,justifyContent:"center",alignItems:"center"},footer:{color:T.ThemeColorMap.HEADER_SECONDARY,textAlign:"center",paddingTop:10,paddingBottom:20}});return m.createElement(G,null,m.createElement(A,{style:n.container},m.createElement(j,{source:{uri:"https://avatars.githubusercontent.com/u/43488869"},style:n.image}),m.createElement(A,{style:n.title},m.createElement(E,{style:n.name},"LocalPin"),m.createElement(E,{style:n.author},"by mafu"))),m.createElement(z,{title:"INFORMATION"},m.createElement(l,{label:"Follow me on Twitter",style:n.info,trailing:l.Arrow,leading:m.createElement(l.Icon,{source:ee}),onPress:()=>{F.openURL("https://twitter.com/m4fn3")}}),m.createElement(l,{label:"Visit my server for help",style:n.info,trailing:l.Arrow,leading:m.createElement(l.Icon,{source:Z}),onPress:()=>{ne.acceptInviteAndTransitionToInviteChannel({inviteKey:"TrCqPTCrdq",context:{location:"Invite Button Embed"},callback:()=>{B.pop()}})}}),m.createElement(l,{label:"Check Source on GitHub",style:n.info,trailing:l.Arrow,leading:m.createElement(l.Icon,{source:X}),onPress:()=>{F.openURL("https://github.com/m4fn3/LocalPin")},onLongPress:()=>e.set("_owner",!e.get("_owner"))})),m.createElement(E,{style:n.footer},`v${L}`))};function C(e,n,o){return window.enmity.utilities.findInReactTree(e,n,o)}function M(e,n,o){window.enmity.settings.set(e,n,o)}function P(e,n,o){return window.enmity.settings.get(e,n,o)}const oe=Q(e=>{var n,o,a;return(a=(o=(n=e._dispatcher)==null?void 0:n._actionHandlers)==null?void 0:o._dependencyGraph)==null?void 0:a.nodes}),_=oe._dispatcher._actionHandlers._dependencyGraph.nodes;function ie(e){let n=Object.keys(_).filter(o=>_[o].name===e);if(n.length)return _[n[0]].actionHandler}function se(e,n,o,a=!1){const[u,y]=I(S.byProps("EmojiRow"),S.byName("ActionSheet",!1)),{Version:w}=k.InfoDictionaryManager;parseInt(w.substring(0,3))>164?typeof y.default=="function"&&e.after(y,"default",(i,s,r)=>{const c=C(r,d=>d.sheetKey);(c==null?void 0:c.sheetKey)===n&&(a?e.before:e.after)(c==null?void 0:c.content,"type",(d,v,p)=>{o(v,p)})}):typeof u.default=="function"&&e.after(u,"default",(i,[s],r)=>{o(s,r)})}const[re,D]=I(S.byProps("getMessage","getMessages"),S.byProps("_currentDispatchActionType","_subscriptions","_actionHandlers","_waitQueue")),[me]=[ie("ChannelPinsStore")];function ae(e,n){e.after(me,"LOAD_PINNED_MESSAGES_SUCCESS",(o,[a],u)=>{n.includes(a.channelId)||n.push(a.channelId)})}function ce(e,n){let o=JSON.parse(P(h,`${e}`,"[]").toString());o.includes(n)||(o.unshift(n),M(h,`${e}`,JSON.stringify(o)))}function le(e,n){let o=JSON.parse(P(h,`${e}`,"[]").toString());o.includes(n)&&(o.splice(o.indexOf(n),1),M(h,`${e}`,JSON.stringify(o)))}function O(e){return JSON.parse(P(h,`${e}`,"[]").toString())}async function de(e,n,o){let a=n.map(s=>s.id),u=Object.keys(o).includes(e)?o[e]:[],y=n.filter(s=>!u.includes(s.id)),w=O(e).filter(s=>!a.includes(s)),i=[];for(const s of w){let r=await ue(e,s);if(!r)continue;let c=re.getMessages(e).receiveMessage(r).get(r.id);i.push(c)}y.unshift(...i.filter(s=>s)),D==null||D.dispatch({type:"LOAD_PINNED_MESSAGES_SUCCESS",messages:y,channelId:e})}async function ue(e,n){let o=await(await fetch(`https://discord.com/api/v9/channels/${e}/messages?around=${n}&limit=1`,{method:"GET",credentials:"include",headers:{authorization:x.getToken()}})).json();if(Array.isArray(o))return o[0]}const b=U("LocalPin"),[ye]=I(S.byProps("openLazy","hideActionSheet")),we=f("ic-location"),ge={...q,onStart(){let e={},n=[],o=0;ae(b,n),b.after(A,"render",(u,y,w)=>{const i=C(w,s=>{var r;return((r=s.type)==null?void 0:r.name)==="ChannelPinsConnected"});i&&b.after(i,"type",(s,[r],c)=>{let d=new Date().getTime();d-o>1e3&&Array.isArray(c.props.messages)&&n.includes(r.channelId)&&(o=d,de(r.channelId,c.props.messages,e).then())})});function a(u,y){var w;const i=u[0];if((w=i.message)!=null&&w.pinned)return;const s=C(y,p=>Array.isArray(p)&&p.find(g=>{var N;return typeof(g==null?void 0:g.key)=="string"&&typeof((N=g==null?void 0:g.props)==null?void 0:N.message)=="string"}));if(!s)return;let r=O(i.channel.id).includes(i.message.id);const c=m.createElement(l,{label:`${r?"Unpin":"Pin"} Message Locally`,leading:m.createElement(l.Icon,{source:we}),onPress:()=>{r?(le(i.channel.id,i.message.id),Object.keys(e).includes(i.channel.id)?e[i.channel.id].push(i.message.id):e[i.channel.id]=[i.message.id]):(ce(i.channel.id,i.message.id),Object.keys(e).includes(i.channel.id)&&e[i.channel.id].includes(i.message.id)&&e[i.channel.id].splice(e[i.channel.id].indexOf(i.message.id),1)),$.open({content:`Successfully ${r?"unpinned":"pinned"} message locally`,source:f("ic_check_24px")}),ye.hideActionSheet()}});let d=s.filter(p=>{var g;return((g=p.props)==null?void 0:g.message)===V.Messages.MESSAGE_ACTION_REPLY}),v=d!=null&&d.length?Number(d[0].key)+1:2;s.splice(v,0,c)}se(b,"MessageLongPressActionSheet",a)},onStop(){b.unpatchAll()},getSettingsPanel({settings:e}){return m.createElement(te,{settings:e})}};R(ge);
