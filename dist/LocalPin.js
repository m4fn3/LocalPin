function k(e){window.enmity.plugins.registerPlugin(e)}const b=window.enmity.modules.common.Constants;window.enmity.modules.common.Clipboard,window.enmity.modules.common.Assets,window.enmity.modules.common.Messages,window.enmity.modules.common.Clyde,window.enmity.modules.common.Avatars;const O=window.enmity.modules.common.Native,m=window.enmity.modules.common.React;window.enmity.modules.common.Dispatcher,window.enmity.modules.common.Storage;const x=window.enmity.modules.common.Toasts;window.enmity.modules.common.Dialog;const B=window.enmity.modules.common.Token;window.enmity.modules.common.REST,window.enmity.modules.common.Settings,window.enmity.modules.common.Users;const $=window.enmity.modules.common.Navigation;window.enmity.modules.common.NavigationNative,window.enmity.modules.common.NavigationStack,window.enmity.modules.common.Theme;const I=window.enmity.modules.common.Linking,H=window.enmity.modules.common.StyleSheet;window.enmity.modules.common.ColorMap,window.enmity.modules.common.Components;const V=window.enmity.modules.common.Locale;window.enmity.modules.common.Profiles,window.enmity.modules.common.Lodash,window.enmity.modules.common.Logger,window.enmity.modules.common.Flux,window.enmity.modules.common.SVG,window.enmity.modules.common.Scenes,window.enmity.modules.common.Moment;const{components:t}=window.enmity;t.Alert,t.Button,t.FlatList;const j=t.Image;t.ImageBackground,t.KeyboardAvoidingView,t.Modal,t.Pressable,t.RefreshControl;const G=t.ScrollView;t.SectionList,t.StatusBar,t.StyleSheet,t.Switch;const T=t.Text;t.TextInput,t.TouchableHighlight,t.TouchableOpacity,t.TouchableWithoutFeedback,t.Touchable;const v=t.View;t.VirtualizedList,t.Form,t.FormArrow,t.FormCTA,t.FormCTAButton,t.FormCardSection,t.FormCheckbox,t.FormDivider,t.FormHint,t.FormIcon,t.FormInput,t.FormLabel,t.FormRadio;const c=t.FormRow,z=t.FormSection;t.FormSelect,t.FormSubLabel,t.FormSwitch,t.FormTernaryCheckBox,t.FormText,t.FormTextColors,t.FormTextSizes;function U(e){return window.enmity.patcher.create(e)}var h="LocalPin",_="1.0.1",J="Pin messages locally",K=[{name:"mafu",id:"519760564755365888"}],Y="#ccffe5",q={name:h,version:_,description:J,authors:K,color:Y};function S(e){return window.enmity.assets.getIDByName(e)}const f={byProps:(...e)=>window.enmity.modules.filters.byProps(...e),byName:(e,n)=>window.enmity.modules.filters.byName(e,n),byTypeName:(e,n)=>window.enmity.modules.filters.byTypeName(e,n),byDisplayName:(e,n)=>window.enmity.modules.filters.byDisplayName(e,n)};function Q(e,n){return window.enmity.modules.getModule(e,n)}function N(...e){return window.enmity.modules.bulk(...e)}function W(...e){return window.enmity.modules.getByProps(...e)}window.enmity.modules.common;const X=S("img_account_sync_github_white"),Z=S("Discord"),ee=S("img_account_sync_twitter_white"),ne=W("acceptInviteAndTransitionToInviteChannel");var te=({settings:e})=>{const n=H.createThemedStyleSheet({container:{flexDirection:"row",justifyContent:"center",alignItems:"center"},image:{width:70,height:70,marginTop:20,marginLeft:20},title:{flexDirection:"column"},name:{fontSize:30,paddingTop:20,paddingLeft:20,paddingRight:30,color:b.ThemeColorMap.HEADER_PRIMARY},author:{fontSize:15,paddingLeft:50,color:b.ThemeColorMap.HEADER_SECONDARY},info:{height:45,paddingTop:3,paddingBottom:3,justifyContent:"center",alignItems:"center"},footer:{color:b.ThemeColorMap.HEADER_SECONDARY,textAlign:"center",paddingTop:10,paddingBottom:20}});return m.createElement(G,null,m.createElement(v,{style:n.container},m.createElement(j,{source:{uri:"https://avatars.githubusercontent.com/u/43488869"},style:n.image}),m.createElement(v,{style:n.title},m.createElement(T,{style:n.name},"LocalPin"),m.createElement(T,{style:n.author},"by mafu"))),m.createElement(z,{title:"INFORMATION"},m.createElement(c,{label:"Follow me on Twitter",style:n.info,trailing:c.Arrow,leading:m.createElement(c.Icon,{source:ee}),onPress:()=>{I.openURL("https://twitter.com/m4fn3")}}),m.createElement(c,{label:"Visit my server for help",style:n.info,trailing:c.Arrow,leading:m.createElement(c.Icon,{source:Z}),onPress:()=>{ne.acceptInviteAndTransitionToInviteChannel({inviteKey:"TrCqPTCrdq",context:{location:"Invite Button Embed"},callback:()=>{$.pop()}})}}),m.createElement(c,{label:"Check Source on GitHub",style:n.info,trailing:c.Arrow,leading:m.createElement(c.Icon,{source:X}),onPress:()=>{I.openURL("https://github.com/m4fn3/LocalPin")},onLongPress:()=>e.set("_owner",!e.get("_owner"))})),m.createElement(T,{style:n.footer},`v${_}`))};function E(e,n,o){return window.enmity.utilities.findInReactTree(e,n,o)}function F(e,n,o){window.enmity.settings.set(e,n,o)}function A(e,n,o){return window.enmity.settings.get(e,n,o)}const oe=Q(e=>e._dispatcher._actionHandlers._dependencyGraph.nodes),P=oe._dispatcher._actionHandlers._dependencyGraph.nodes;function ie(e){let n=Object.keys(P).filter(o=>P[o].name===e);if(n.length)return P[n[0]].actionHandler}const[se,L]=N(f.byProps("getMessage","getMessages"),f.byProps("_currentDispatchActionType","_subscriptions","_actionHandlers","_waitQueue")),[me]=[ie("ChannelPinsStore")];function ae(e,n){e.after(me,"LOAD_PINNED_MESSAGES_SUCCESS",(o,[y],i)=>{n.includes(y.channelId)||n.push(y.channelId)})}function re(e,n){let o=JSON.parse(A(h,`${e}`,"[]").toString());o.includes(n)||(o.unshift(n),F(h,`${e}`,JSON.stringify(o)))}function ce(e,n){let o=JSON.parse(A(h,`${e}`,"[]").toString());o.includes(n)&&(o.splice(o.indexOf(n),1),F(h,`${e}`,JSON.stringify(o)))}function M(e){return JSON.parse(A(h,`${e}`,"[]").toString())}async function le(e,n,o){let y=n.map(s=>s.id),i=Object.keys(o).includes(e)?o[e]:[],u=n.filter(s=>!i.includes(s.id)),l=M(e).filter(s=>!y.includes(s)),r=[];for(const s of l){let a=await de(e,s);if(!a)continue;let d=se.getMessages(e).receiveMessage(a).get(a.id);r.push(d)}u.unshift(...r.filter(s=>s)),L==null||L.dispatch({type:"LOAD_PINNED_MESSAGES_SUCCESS",messages:u,channelId:e})}async function de(e,n){let o=await(await fetch(`https://discord.com/api/v9/channels/${e}/messages?around=${n}&limit=1`,{method:"GET",credentials:"include",headers:{authorization:B.getToken()}})).json();if(Array.isArray(o))return o[0]}const p=U("LocalPin"),[R,D,ue]=N(f.byProps("EmojiRow"),f.byName("ActionSheet",!1),f.byProps("openLazy","hideActionSheet"),f.byProps("getMessage","getMessages")),{Version:ye}=O.InfoDictionaryManager,we=S("ic-location"),ge={...q,onStart(){let e={},n=[],o=0;ae(p,n),p.after(v,"render",(i,u,l)=>{const r=E(l,s=>{var a;return((a=s.type)==null?void 0:a.name)==="ChannelPinsConnected"});r&&p.after(r,"type",(s,[a],d)=>{let w=new Date().getTime();w-o>1e3&&Array.isArray(d.props.messages)&&n.includes(a.channelId)&&(o=w,le(a.channelId,d.props.messages,e).then())})});function y(i,u){if(i.message.pinned)return;const l=E(u,w=>Array.isArray(w)&&w.find(g=>{var C;return typeof(g==null?void 0:g.key)=="string"&&typeof((C=g==null?void 0:g.props)==null?void 0:C.message)=="string"}));let r=M(i.channel.id).includes(i.message.id);const s=m.createElement(c,{label:`${r?"Unpin":"Pin"} Message Locally`,leading:m.createElement(c.Icon,{source:we}),onPress:()=>{r?(ce(i.channel.id,i.message.id),Object.keys(e).includes(i.channel.id)?e[i.channel.id].push(i.message.id):e[i.channel.id]=[i.message.id]):(re(i.channel.id,i.message.id),Object.keys(e).includes(i.channel.id)&&e[i.channel.id].includes(i.message.id)&&e[i.channel.id].splice(e[i.channel.id].indexOf(i.message.id),1)),x.open({content:`Successfully ${r?"unpinned":"pinned"} message locally`,source:S("ic_check_24px")}),ue.hideActionSheet()}});let a=l.filter(w=>{var g;return((g=w.props)==null?void 0:g.message)===V.Messages.MESSAGE_ACTION_REPLY}),d=a?a.length?Number(a[0].key)+1:void 0:2;d&&l.splice(d,0,s)}parseInt(ye.substring(0,3))>164?typeof D.default=="function"&&p.after(D,"default",(i,u,l)=>{const r=E(l,s=>s.sheetKey);(r==null?void 0:r.sheetKey)==="MessageLongPressActionSheet"&&p.after(r==null?void 0:r.content,"type",(s,[a],d)=>{y(a,d)})}):typeof R.default=="function"&&p.after(R,"default",(i,[u],l)=>{y(u,l)})},onStop(){p.unpatchAll()},getSettingsPanel({settings:e}){return m.createElement(te,{settings:e})}};k(ge);
